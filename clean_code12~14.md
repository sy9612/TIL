## 12장 창발성

<SW 설계 품질을 위한 4가지 규칙>

1. 모든 테스트를 실행한다
   - 테스트 케이스를 만들고 돌리면 낮은 결합도와 높은 응집력이라는 객체 지향 방법론이 지향하는 목표를 저절로 달성
   - 테스트 케이스 작성 후 코드와 클래스 정리
   - 테스트 케이스를 돌려 기존 기능이 깨지지 않는지 확인
2. 중복을 없앤다
   - 공통적인 코드를 새 메소드로 뽑기
   - 소규모 재사용은 시스템 복잡도를 줄여줌
3. 프로그래머 의도를 표현한다
   - 좋은 이름을 선택해라
   - 함수와 클래스 크기를 가능한 줄여라
   - 표준 명칭을 사용하라, 디자인 패턴은 의사소통과 표현력 강화가 주요 목적
   - 단위 테스트를 꼼꼼히 작성하라
4. 클래스와 메소드 수를 최소로 줄인다
   - 함수와 클래스 크기를 작게 유지하면서 동시에 시스템 크기도 작게 유지
   - but, 이것보단 테스트 케이스를 만들고 중복을 제거하고 의도를 표현하는 작업이 더 중요



## 13장 동시성

#### 동시성 특징

1. 때로 성능을 높여준다.
   - 대기 시간이 아주 길어 여러 스레드가 프로세서를 공유하는 경우
   - 여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우
   - 둘다 일상적으로 발생하진 않음
2. 동시성을 구현하면 시스템 구조가 크게 달라진다.
   - 성능 측면에서 부하가 걸림, 코드도 더 짜야함
3. 부하를 유발한다.
4. 복잡하다.
5. 버그 재현이 어렵다.
   - 결함이 일회성 문제로 간주되기 쉬움
6. 구현하기 위해선 근본적인 설계 전략을 재고 해야한다.



#### 동시성을 구현하기 어려운 이유

두 스레드가 자바 코드 한 줄을 거쳐가는 경로는 수없이 많은데 그 중 **일부 경로만** 잘못된 결과를 내놓음



#### 동시성 방어 원칙

1. 단일 책임 원칙

   - 동시성 관련 코드는 다른 코드와 분리
   - 공유 객체를 사용하는 코드 내 임계 영역을 synchronized 키워드로 보호, 공유 자료를 최대한 줄이기
   - 객체를 복사해 읽기 전용으로 사용하기
     - 내부 잠금을 없애 절약한 수행 시간  == 사본 생성, 가비지 컬렉션에 드는 부하 일 가능성이 큼
   - 독자적인 스레드로 다른 스레드와 자료를 공유하지 않기

2. 라이브러리를 이해하라

   - 언어가 제공하는 클래스를 검토

3. 실행 모델을 이해하라

   1. 생산자-소비자
      - 생산자 스레드와 소비자 스레드는 서로에게 시그널을 보냄
      - 생산자 -> 소비자 : 대기열에 정보가 있음
      - 소비자 -> 생산자 : 대기열에 빈 공간 있음
   2. 읽기-쓰기
      - 읽기 스레드가 사용중일 때 쓰기 스레드가 갱신하고자 할 수 있음
      - 읽기 스레드의 요구와 쓰기 스레드의 요구를 적절히 만족시켜 처리율⬆️, 기아방지 해법이 필요

4. 동기화하는 메서드 사이에 존재하는 의존성을 이해하라

   - 공유 객체 하나에는 메서드 하나만 사용하기
   - 여러 메서드가 필요할 시
     - 클라이언트에서 잠금 : 클라이언트에서 첫 번째 메서드 호출 전 서버를 잠금
     - 서버에서 잠금 : 서버를 잠그고 모든 메서드를 호출한 후 잠금을 해제
     - 연결 서버 : 잠금을 수행하는 중간 단계 생성

5. 동기화 하는 부분을 작게 만들어라

   - 락은 스레드를 지연시키고 부하를 가중
   - 임계 영역 수를 최대한 줄여야 함

6. 올바른 종료 코드는 구현하기 어렵다

   - 가장 많이 발생하는 문제 **데드락**
   - 깔끔하게 종료하는 다중 스레드 코드를 위한 시간 투자가 필요

7. 스레드 코드 테스트 하기

   - 문제를 노출하는 테스트 케이스를 작성하기

   - 시스템 실패를 일회성으로 치부하지 말기

   - 스레드 환경 밖에서 코드를 올바로 돌려보기

   - 다양한 환경에 쉽게 끼워넣을 수 있게 코드 구현하기

   - 다중 스레드를 쓰는 코드 부분을 상황에 맞게 조율할 수 있게 작성하기

     - 프로그램이 돌아갖는 도중 스레드 개수를 변경하는 방법
     - 스스로 스레드 개수를 조율하는 코드 고려하기

   - 프로세서보다 많은 스레드를 돌려 스와핑을 일으켜 보기

   - 코드가 돌아갈 가능성이 있는 플랫폼 전부에서 테스트 수행하기

   - 코드에 보조코드를 넣어 돌려 강제 실패 유발하기

     - 보조 코드를 추가해 코드가 실행되는 순서를 바꿈

       1. 직접 구현하기

          문제점 

          - 보조 코드 삽입 위치 찾아야 함
          - 함수 호출 위치 찾아야 함
          - 배포 환경에선 보조 코드를 지워야 함
          - 오류가 드러나지 않을 확률이 높음

       2. 자동화

          - AOF, CGLIB, ASM 등의 도구 사용
          - ConTest 도구 유사하게 동작하지만 좀 더 복잡

   -  좋은 테스트 케이스와 흔들기 기법은 오류를 드러낼 확률을 높여줌

     

8. 결론

   1. 다중 스레드 코드를 작성한다면 각별히 깨끗하게 코드를 짜야함
   2. SRP 준수해야함
   3. 스레드 코드를 테스트 할때는 전적으로 스레드만 테스트 해야함
   4. 사용하는 라이브러리와 기본 알고리즘을 이해 해야함
   5. 보호할 코드 영역을 찾아내는 방법과 잠그는 방법을 이해해야 함
   6. 스레드 코드는 많은 플랫폼에서 많은 설정으로 반복해서 테스트 해야함
   7. 보조 코드를 사용하면 오류를 찾을 가능성이 높아짐



## 14장

